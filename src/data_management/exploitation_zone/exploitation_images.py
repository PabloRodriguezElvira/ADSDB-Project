import io, hashlib, time
import numpy as np
from tqdm import tqdm 
from PIL import Image, UnidentifiedImageError
from minio.error import S3Error

from src.common.minio_client import get_minio_client
from src.common.chroma_client import get_client, get_image_collection
import src.common.global_variables as config



def _hash_bytes(b: bytes, n: int = 16) -> str:
    return hashlib.sha256(b).hexdigest()[:n]

def list_objects(client, bucket, prefix):
    return [
        obj for obj in client.list_objects(bucket, prefix=prefix, recursive=True)
        if not obj.object_name.endswith("/")
    ]

def ingest_trusted_images(batch_size: int = 128) -> int:
    client_s3 = get_minio_client()
    ch_client = get_client()
    col = get_image_collection(ch_client)

    objects = list_objects(client_s3, config.TRUSTED_BUCKET, config.TRUSTED_IMAGE_PATH)
    total_objects = len(objects)
    print(f"Processing {total_objects} images from MinIO...\n")

    ids, imgs_np, metas = [], [], []
    total = 0
    now = int(time.time())

    for obj in tqdm(objects, desc="Ingesting images", unit="img"):
        try:
            s3obj = client_s3.get_object(config.TRUSTED_BUCKET, obj.object_name)
            data = s3obj.read()
            s3obj.close()
            s3obj.release_conn()
        except S3Error as e:
            tqdm.write(f"SKIP (MinIO): {obj.object_name} ({e})")
            continue

        try:
            im = Image.open(io.BytesIO(data)).convert("RGB")
            arr = np.asarray(im, dtype=np.uint8)
        except (UnidentifiedImageError, OSError) as e:
            tqdm.write(f"SKIP (PIL): {obj.object_name} ({e})")
            continue

        fid = _hash_bytes(data)
        ids.append(fid)
        imgs_np.append(arr)
        metas.append({
            "source_key": obj.object_name,
            "file_hash": fid,
            "size": len(data),
            "created_at": now,
        })

        # Flush por lotes
        if len(ids) >= batch_size:
            col.add(ids=ids, images=imgs_np, metadatas=metas)
            total += len(ids)
            ids.clear()
            imgs_np.clear()
            metas.clear()

    # Resto final
    if ids:
        col.add(ids=ids, images=imgs_np, metadatas=metas)
        total += len(ids)

    print(f"\nOK - Images ingested into Chroma: {total}")
    return total


if __name__ == "__main__":
    ingest_trusted_images()
