import io, hashlib, time
from PIL import Image, UnidentifiedImageError
from minio.error import S3Error
from src.common.minio_client import get_minio_client
from src.common.chroma_client import get_client, get_image_collection

TRUSTED_BUCKET = "trusted-zone"
SRC_PREFIX = "trusted/image_data/"

def _hash_bytes(b: bytes, n: int = 16) -> str:
    return hashlib.sha256(b).hexdigest()[:n]

def list_objects(client, bucket, prefix):
    for obj in client.list_objects(bucket, prefix=prefix, recursive=True):
        if not obj.object_name.endswith("/"):
            yield obj

def ingest_trusted_images(batch_size: int = 128) -> int:
    client_s3 = get_minio_client()
    ch_client = get_client()
    col = get_image_collection(ch_client)

    ids, pil_imgs, metas = [], [], []
    total = 0
    now = int(time.time())

    for obj in list_objects(client_s3, TRUSTED_BUCKET, SRC_PREFIX):
        try:
            s3obj = client_s3.get_object(TRUSTED_BUCKET, obj.object_name)
            data = s3obj.read()
            s3obj.close()
            s3obj.release_conn()
        except S3Error as e:
            print("SKIP (MinIO):", obj.object_name, e)
            continue

        try:
            im = Image.open(io.BytesIO(data)).convert("RGB")
        except (UnidentifiedImageError, OSError) as e:
            print("SKIP (PIL):", obj.object_name, e)
            continue

        fid = _hash_bytes(data)
        ids.append(fid)
        pil_imgs.append(im)
        metas.append({
            "source_key": obj.object_name,
            "file_hash": fid,
            "size": len(data),
            "created_at": now,
        })

        # Flush by packages
        if len(ids) >= batch_size:
            col.add(ids=ids, images=pil_imgs, metadatas=metas)
            total += len(ids)
            ids.clear()
            pil_imgs.clear()
            metas.clear()

    if ids:
        col.add(ids=ids, images=pil_imgs, metadatas=metas)
        total += len(ids)

    print(f"OK - Images ingested into Chroma: {total}")
    return total

if __name__ == "__main__":
    ingest_trusted_images()
